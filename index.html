<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enterprise Dashboard</title>

  <!-- Combine CSS links and add preconnect for CDN -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="node_modules/gridstack/dist/gridstack.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="src/style.css">

  <!-- Load ionicons after critical content -->
  <script defer src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.js"></script>
  <script nomodule defer src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>

<body>
  <!-- Side Panel -->
  <div class="side-panel collapsed" id="sidePanel">
    <div class="side-panel-header">
      <h5>Widget Library</h5>
    </div>
    <div class="sidebar" id="widgetLibrary">
      <!-- Widgets will be dynamically loaded here from widget.json -->
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content expanded" id="mainContent">
    <div class="dashboard-header">
      <div class="dashboard-title">
        <h1>Executive Dashboard</h1>
        <p>Monitor your key performance indicators</p>
      </div>
      <div class="dashboard-actions">
        <button onclick="compact()" class="btn btn-primary">
          <i class="fas fa-compress-alt"></i> Compact Layout
        </button>
        <div class="toggle-label">
          Edit Mode:
          <label class="toggle-switch">
            <input type="checkbox" id="editToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>
    
    <div class="grid-stack" id="left_grid"></div>
  </div>

  <!-- Move scripts to the end of body and optimize loading -->
  <script src="node_modules/gridstack/dist/gridstack-all.js" defer></script>
  <script src="events.js" defer></script>
  
  <script>
    // Global variable to store widget data
    let widgetData = [];
    
    // Function to load widget data from JSON
    async function loadWidgetData() {
      try {
        const response = await fetch('/src/widget.json');
        if (!response.ok) {
          throw new Error('Failed to load widget data');
        }
        widgetData = await response.json();
        populateWidgetLibrary();
      } catch (error) {
        console.error('Error loading widget data:', error);
        // Fallback to empty array if loading fails
        widgetData = [];
      }
    }
    
    // Function to populate the widget library sidebar
    function populateWidgetLibrary() {
      const widgetLibrary = document.getElementById('widgetLibrary');
      widgetLibrary.innerHTML = '';
      
      widgetData.forEach(widget => {
        const widgetElement = document.createElement('div');
        widgetElement.className = 'sidebar-item grid-stack-item';
        
        widgetElement.innerHTML = `
          <div class="widget-header">
            <div class="widget-icon">
              <ion-icon name="${widget.pic}"></ion-icon>
            </div>
            <div>
              <h4>${widget.name}</h4>
              <p>${widget.description}</p>
            </div>
          </div>
        `;
        
        widgetLibrary.appendChild(widgetElement);
      });
    }
    
    // Function to create a widget from the library
    function createWidgetFromLibrary(widgetId) {
      const widget = widgetData.find(w => w.id == widgetId);
      if (!widget) return null;
      
      return {
        x: 0,
        y: 0,
        w: widget.defaultSize[0],
        h: widget.defaultSize[1],
        minW: widget.minSize[0],
        minH: widget.minSize[1],
        maxW: widget.maxSize[0],
        maxH: widget.maxSize[1],
        content: `<div class="grid-stack-item-content"> <button class="close-btn" style="display: flex" onclick="removeWidget(this)">×</button>${widget.children} </div>`,
        type: widget.name.toLowerCase().replace(/\s+/g, '-'),
        id: `${widget.id}`
      };
    }

    // Use DOMContentLoaded to ensure the DOM is ready
    document.addEventListener('DOMContentLoaded', async function() {
      // Load widget data first
      await loadWidgetData();
      
      // NOTE: REAL apps would sanitize-html or DOMPurify before blindly setting innerHTML. see #2736
      GridStack.renderCB = function(el, w) {
        el.innerHTML = w.content;
      };

      const options = {
        column: 12,
        minRow: 1,
        cellHeight: 70,
        float: true,
        removable: true,
        acceptWidgets: true,
        disableDrag: true,
        styleInHead: true,
        resizable: {
          handles: 'e, se, s, sw, w'
        }
      };
      
      let grid = GridStack.init(options, '#left_grid');
      
      // Save layout function
      function saveLayout() {
        const widgets = grid.save();
        
        const enhancedWidgets = widgets.map(widget => {
          // Try to determine the widget type based on content
          let type = 'custom';
          const widgetId = widget.id ? widget.id.replace('widget-', '') : '';
          const matchedWidget = widgetData.find(w => w.id == widgetId);
          
          if (matchedWidget) {
            type = matchedWidget.name.toLowerCase().replace(/\s+/g, '-');
          }
          
          return {
            ...widget,
            type: type
          };
        });
        
        localStorage.setItem('executiveDashboardLayout', JSON.stringify(enhancedWidgets));
      }

      // Load layout function
      function loadLayout() {
        const savedLayout = localStorage.getItem('executiveDashboardLayout');
        if (savedLayout) {
          try {
            grid.removeAll();
            const widgets = JSON.parse(savedLayout);
            grid.load(widgets);
            
            // Initialize charts after loading
            setTimeout(initializeCharts, 100);
          } catch (e) {
            console.error('Error loading layout:', e);
            loadInitialWidgets();
          }
        } else {
          loadInitialWidgets();
        }
      }

      // Load initial widgets function
      function loadInitialWidgets() {
        grid.removeAll();
        
        // Load first 3 widgets by default if no saved layout exists
        const defaultWidgets = widgetData.slice(0, 3).map(widget => ({
          x: 0,
          y: 0,
          w: widget.defaultSize[0],
          h: widget.defaultSize[1],
          minW: widget.minSize[0],
          minH: widget.minSize[1],
          maxW: widget.maxSize[0],
          maxH: widget.maxSize[1],
          content: `<button class="close-btn" style="display: flex;" onclick="removeWidget(this)">×</button>${widget.children}`,
          id: `${widget.id}`
        }));
        
        // Position the default widgets
        if (defaultWidgets.length > 0) defaultWidgets[0].x = 0;
        if (defaultWidgets.length > 1) defaultWidgets[1].x = 3;
        if (defaultWidgets.length > 2) defaultWidgets[2].x = 6;
        
        grid.load(defaultWidgets);
        setTimeout(initializeCharts, 100);
      }

      // Initialize in non-edit mode
      const editToggle = document.getElementById('editToggle');
      const sidePanel = document.getElementById('sidePanel');
      const mainContent = document.getElementById('mainContent');
      
      editToggle.checked = false;
      grid.enableMove(false);
      grid.enableResize(false);
      
      // Initialize charts
      function initializeCharts() {
        const analyticsChartCtx = document.getElementById('analyticsChart');
        if (analyticsChartCtx) {
          new Chart(analyticsChartCtx, {
            type: 'bar',
            data: {
              labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
              datasets: [{
                label: 'Revenue ($)',
                data: [12000, 19000, 15000, 22000, 18000, 24000],
                backgroundColor: 'rgba(58, 123, 213, 0.6)',
                borderColor: 'rgba(58, 123, 213, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Revenue'
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Month'
                  }
                }
              }
            }
          });
        }
      }

      // Initialize charts for initial load
      setTimeout(initializeCharts, 100);

      window.compact = function() {
        grid.compact();
      };

      window.removeWidget = function(button) {
        const widget = button.closest('.grid-stack-item');
        if (widget) {
          grid.removeWidget(widget, true, true);
          saveLayout();
        }
      };

      // Expose save and load functions to global scope
      window.saveLayout = saveLayout;
      window.loadLayout = loadLayout;

      // Edit mode toggle functionality
      editToggle.addEventListener('change', function() {
        const isEditMode = this.checked;
        
        // Update grid options
        grid.enableMove(isEditMode);
        grid.enableResize(isEditMode);
        grid.opts.disableDrag = !isEditMode;
        
        // Toggle close buttons visibility
        document.querySelectorAll('.close-btn').forEach(btn => {
          btn.style.display = isEditMode ? 'flex' : 'none';
        });
        
        // Toggle drag from sidebar
        if (isEditMode) {
          // Create widgets array for setupDragIn
          const dragWidgets = widgetData.map(widget => {
            return {
              w: widget.defaultSize[0],
              h: widget.defaultSize[1],
              minW: widget.minSize[0],
              minH: widget.minSize[1],
              maxW: widget.maxSize[0],
              maxH: widget.maxSize[1],
              content: `<button class="close-btn" style="display: flex" onclick="removeWidget(this)">×</button>${widget.children} `,
              id: `${widget.id}`
            };
          });
          
          // Use setupDragIn with GridStackWidget array instead of helper function
          GridStack.setupDragIn('.sidebar-item', { appendTo: 'body',helper:'clone' }, dragWidgets);
        } else {
          document.querySelectorAll('.sidebar-item').forEach(el => {
            el.draggable = false;
          });
        }
        
        // Toggle panel visibility
        sidePanel.classList.toggle('collapsed', !isEditMode);
        mainContent.classList.toggle('expanded', !isEditMode);
      });

      // Save layout on grid changes
      grid.on('added removed change', function() {
        if (editToggle.checked) {
          saveLayout();
        }
      });

      // Load the saved layout by default or initial widgets
      loadLayout();
    });
  </script>
</body>
</html>